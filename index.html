<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MP3 Deepfryer</title>
<style>
    body {
        background: #111;
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
    }
    input, button {
        margin: 10px;
        padding: 8px;
    }
    .slider {
        width: 300px;
    }
    .box {
        background: #1c1c1c;
        padding: 20px;
        border-radius: 10px;
        display: inline-block;
    }
</style>
</head>
<body>

<h1>ðŸ”¥ MP3 Deepfryer ðŸ”¥</h1>
<p>Destroy your audio quality on purpose</p>

<div class="box">
    <input type="file" id="fileInput" accept="audio/*"><br>

    <label>Sample Rate (Hz)</label><br>
    <input type="range" min="4000" max="44100" value="8000" class="slider" id="sampleRate">
    <span id="srVal">8000</span><br>

    <label>Bit Depth</label><br>
    <input type="range" min="2" max="16" value="4" class="slider" id="bitDepth">
    <span id="bdVal">4</span><br>

    <label>Distortion</label><br>
    <input type="range" min="0" max="100" value="30" class="slider" id="distortion">
    <span id="distVal">30</span><br>

    <button onclick="processAudio()">Deepfry</button>
</div>

<br><br>
<audio id="output" controls></audio>
<br>
<a id="download" download="deepfried.wav">Download</a>

<script>
const sr = document.getElementById("sampleRate");
const bd = document.getElementById("bitDepth");
const dist = document.getElementById("distortion");

sr.oninput = () => srVal.textContent = sr.value;
bd.oninput = () => bdVal.textContent = bd.value;
dist.oninput = () => distVal.textContent = dist.value;

async function processAudio() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) return alert("Upload an audio file first!");

    const audioCtx = new AudioContext();
    const arrayBuffer = await file.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

    const offlineCtx = new OfflineAudioContext(
        audioBuffer.numberOfChannels,
        audioBuffer.length,
        sr.value
    );

    const source = offlineCtx.createBufferSource();
    source.buffer = audioBuffer;

    const waveShaper = offlineCtx.createWaveShaper();
    waveShaper.curve = makeDistortionCurve(dist.value);

    source.connect(waveShaper);
    waveShaper.connect(offlineCtx.destination);
    source.start();

    const rendered = await offlineCtx.startRendering();
    const reduced = bitCrush(rendered, bd.value);

    const wavBlob = bufferToWave(reduced);
    const url = URL.createObjectURL(wavBlob);

    output.src = url;
    download.href = url;
}

function makeDistortionCurve(amount) {
    const k = amount * 10;
    const n = 44100;
    const curve = new Float32Array(n);
    for (let i = 0; i < n; i++) {
        const x = (i * 2) / n - 1;
        curve[i] = Math.tanh(x * k);
    }
    return curve;
}

function bitCrush(buffer, bits) {
    const step = Math.pow(0.5, bits);
    for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
        const data = buffer.getChannelData(ch);
        for (let i = 0; i < data.length; i++) {
            data[i] = Math.round(data[i] / step) * step;
        }
    }
    return buffer;
}

function bufferToWave(buffer) {
    const length = buffer.length * buffer.numberOfChannels * 2 + 44;
    const view = new DataView(new ArrayBuffer(length));
    let offset = 0;

    function writeString(s) {
        for (let i = 0; i < s.length; i++) {
            view.setUint8(offset++, s.charCodeAt(i));
        }
    }

    writeString("RIFF");
    view.setUint32(offset, length - 8, true); offset += 4;
    writeString("WAVE");
    writeString("fmt ");
    view.setUint32(offset, 16, true); offset += 4;
    view.setUint16(offset, 1, true); offset += 2;
    view.setUint16(offset, buffer.numberOfChannels, true); offset += 2;
    view.setUint32(offset, buffer.sampleRate, true); offset += 4;
    view.setUint32(offset, buffer.sampleRate * 2, true); offset += 4;
    view.setUint16(offset, buffer.numberOfChannels * 2, true); offset += 2;
    view.setUint16(offset, 16, true); offset += 2;
    writeString("data");
    view.setUint32(offset, length - offset - 4, true); offset += 4;

    for (let i = 0; i < buffer.length; i++) {
        for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
            let sample = buffer.getChannelData(ch)[i];
            sample = Math.max(-1, Math.min(1, sample));
            view.setInt16(offset, sample * 0x7fff, true);
            offset += 2;
        }
    }
    return new Blob([view], { type: "audio/wav" });
}
</script>

</body>
</html>
